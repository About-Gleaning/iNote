## 目标概述

* 点击录音后隐藏底部其他按钮，仅保留录音与“完成”。

* 录音按钮支持：开始 → 暂停 → 继续 → 暂停 → 继续。

* 在录音按钮旁新增“完成”按钮，点击后结束录音并提交给 AI。

* 录音时展示“已录时长/上限时长”，设置 20 秒上限，超过自动停止但不提交。

## 技术方案

### ViewModel 状态与逻辑

* 新增录音状态枚举：`RecordState { idle, recording, paused }`，替换/补充现有 `isRecording`。

* 新增属性：

  * `@Published var recordState: RecordState = .idle`

  * `@Published var elapsedSeconds: Double = 0`

  * `let maxDuration: Double = 20`

  * `private var recordTimer: Timer?`

  * （沿用）`private var recorder: AVAudioRecorder?`

* 方法调整：

  * `toggleRecord(context:)` 改为三态切换：

    * `idle → startRecord`

    * `recording → pauseRecord`

    * `paused → resumeRecord`

  * 新增：`pauseRecord()` 与 `resumeRecord()`，分别调用 `recorder?.pause()` 与 `recorder?.record()`，更新 `recordState`。

  * 新增：`finishRecord(context:)` 统一结束与提交（替代目前的 `stopRecord(context:)` 的外部调用）。

  * `startRecord(context:)` 中开始 `recordTimer`，定时（建议 0.1s）读取 `recorder?.currentTime` 更新 `elapsedSeconds`，到达 `maxDuration` 自动调用 `finishRecord(context:)`。

* AI 提交路径复用：`finishRecord(context:)` 内部与现有 `stopRecord(context:)` 相同流程，最终调用 `sendAudioAndTextToAI(audioURL:context:)`。

### UI（EntryView\.swift）改造

* 位置：底部安全区内的自定义操作栏（`iNote/EntryView.swift:127–201`）。

* 录音按钮图标规则：

  * `idle`：`mic.fill`

  * `recording`：`pause.fill`

  * `paused`：`play.fill`

* 隐藏其他按钮：当 `recordState != .idle` 时，隐藏“更多/拍照/录像”等，只显示：

  * 中间：录音按钮（用于暂停/继续）

  * 旁边：新增“完成”按钮（结束并提交）

  * 上方或旁侧：时长显示 `mm:ss / 00:20`

* 交互绑定：

  * 录音按钮：`vm.toggleRecord(context: context)`

  * 完成按钮：`vm.finishRecord(context: context)`

* 时长显示：使用 `vm.elapsedSeconds` 渲染文本；仅在 `recordState != .idle` 时显示。

## 代码改动点（定位）

* `iNote/EntryViewModel.swift`

  * 切换逻辑：`toggleRecord(context:)`（38–40）

  * 开始录音：`startRecord(context:)`（42–56）

  * 停止录音：`stopRecord(context:)`（68–75）→ 保留内部实现，改为被 `finishRecord` 调用；对外触发改由“完成”按钮。

  * AI 提交：`sendAudioAndTextToAI(audioURL:context:)`（282–383）复用，不改协议。

* `iNote/EntryView.swift`

  * 底部栏：`safeAreaInset(edge: .bottom) { ... }`（127–201）

  * 录音按钮：`Button(action: { vm.toggleRecord(context: context) })` 与图标（160–173）按状态切换。

  * 新增“完成”按钮：紧邻录音按钮，行为调用 `vm.finishRecord(context: context)`。

  * 新增时长显示：绑定 `vm.elapsedSeconds`。

## 细节与边界处理

* 权限：若 `AVAudioSession` 激活或 `AVAudioRecorder` 初始化失败，提示并回退到 `idle`。

* 自动停止：超时触发后，确保 `recordTimer` 无泄漏，安全置空并提交。

* 暂停/继续：保持 `AVAudioSession` active，避免会话被系统中断；在 `onDisappear`/重置逻辑中确保清理。

* UI 风格：沿用现有 `AppColors`、阴影与圆角风格；“完成”按钮建议使用 `AppColors.accent` 或与录音状态一致的强调色。

## 验证计划

* 手动流程：

  * 点击录音 → 仅显示录音与完成，计时开始。

  * 点击录音暂停 → 图标变“暂停”→ 显示“继续”，计时停滞。

  * 再次点击录音继续 → 计时续增。

  * 点击“完成” → 结束并提交，弹出编辑器（现有 `shouldShowEditor`）。

  * 超过 20 秒自动结束并提交。

* 回归：拍照/录像流程不受影响；AI 状态提示正常更新。

## 交付

* 按上述方案修改两处文件，保持函数命名与项目风格一致，不改外部接口。

* 若您确认方案，我将实施代码改造并进行本地运行验证。

